<template>
  <view class="search-container">
    <view class="search-box" :style="{ backgroundColor: bgColor, borderRadius: borderRadius }">
      <!-- 搜索图标 -->
      <view class="search-icon" @click="onIconClick">
        <uni-icons :type="leftIconType" :size="iconSize" :color="iconColor" />
      </view>
      
      <!-- 输入框 -->
      <input 
        class="search-input"
        type="text"
        :placeholder="placeholder"
        :disabled="disabled"
        v-model="searchValue"
        @input="onInput"
        @confirm="onConfirm"
        @focus="onFocus"
        @blur="onBlur"
      />
      
      <!-- 清除按钮 -->
      <view v-if="showClearBtn" class="clear-btn" @click="clearSearch">
        <uni-icons type="close" size="16" color="#999" />
      </view>
      
      <!-- 右侧图标区域 -->
      <view v-if="rightIcons && rightIcons.length > 0" class="right-icons">
        <view 
          v-for="(icon, index) in rightIcons" 
          :key="index" 
          class="right-icon"
          @click="() => onRightIconClick(index)"
        >
          <uni-icons :type="icon.type" :size="icon.size || iconSize" :color="icon.color || iconColor" />
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  name: "uni-mysearch",
  props: {
    placeholder: { type: String, default: '搜索...' },
    value: { type: String, default: '' },
    disabled: { type: Boolean, default: false },
    leftIconType: { type: String, default: 'search' },
    rightIcons: { type: Array, default: () => [] },
    iconSize: { type: Number, default: 18 },
    iconColor: { type: String, default: '#999' },
    bgColor: { type: String, default: '#F5F5F5' },
    borderRadius: { type: String, default: '20rpx' }
  },
  data() {
    return {
      searchValue: this.value,
      showClearBtn: false
    };
  },
  watch: {
    // 监听外部值变化
    value(newVal) {
      this.searchValue = newVal;
      this.updateClearBtn();
    }
  },
  mounted() {
    this.updateClearBtn();
  },
  methods: {
    // 更新清除按钮显示状态
    updateClearBtn() {
       // 优化判断条件：当输入框有内容且未禁用时显示清除按钮
		this.showClearBtn = !this.disabled && this.searchValue.trim().length > 0;
		// console.log('清除按钮状态:', this.showClearBtn);
},
    
    // 输入事件处理
    onInput(e) {
		const value = e.detail ? e.detail.value : e.value || '';
		this.searchValue = value;
		this.updateClearBtn();
		this.$emit('input', this.searchValue);
    },
    
    // 确认搜索
    onConfirm() {
      this.$emit('confirm', this.searchValue);
    },
    
    // 聚焦事件
    onFocus(e) {
      this.updateClearBtn(); // 修复：聚焦时也更新清除按钮状态
      this.$emit('focus', e);
    },
    
    // 失焦事件
    onBlur(e) {
      this.updateClearBtn(); // 修复：失焦时也更新清除按钮状态
      this.$emit('blur', e);
    },
    
    // 清除搜索内容
    clearSearch() {
      this.searchValue = '';
      this.updateClearBtn();
      this.$emit('clear');
      
      // 修复：确保清除后触发输入事件，通知父组件值已更新
      this.$emit('input', '');
    },
    
    // 左侧图标点击
    onIconClick() {
      this.$emit('iconClick');
    },
    
    // 右侧图标点击
    onRightIconClick(index) {
      this.$emit('rightIconClick', index);
    }
  }
}
</script>

<style lang="scss" scoped>
.search-container {
  padding: 15rpx;
}

.search-box {
  display: flex;
  align-items: center;
  height: 68rpx;
  padding: 0 20rpx;
}

.search-icon {
  margin-right: 12rpx;
}

.search-input {
  flex: 1;
  height: 100%;
  font-size: 28rpx;
  color: #333;
}

.clear-btn {
  margin-left: 10rpx;
  padding: 0 10rpx;
}

.right-icons {
  display: flex;
  margin-left: 15rpx;
}

.right-icon {
  margin-left: 20rpx;
}
</style>